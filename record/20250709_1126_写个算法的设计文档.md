
# CAN-RGB + CANET-33K 入侵检测设计文档  
> 目标：给已有CAN总线 / 神经网络背景的研究生
> 范围：数据预处理 → RGB 编码 → 轻量 CNN 设计 → 一次性剪枝 + INT8 PTQ → 评估  
> 
---

## 0. 环境配置

| 类别      | 版本                                                                                         |
| ------- | ------------------------------------------------------------------------------------------ |
| Python  | 3.11                                                                                       |
| PyTorch | 2.5.1                                                                                      |

---

## 1、数据集与目录结构
[HCRL - Car-Hacking Dataset](https://ocslab.hksecurity.net/Datasets/car-hacking-dataset)
### HCRL Car-Hacking Dataset 
Car-Hacking-Dataset/
├── normal.csv                  # 正常行驶（约 30 min）
├── DoS_dataset.csv             # DoS 注入
├── Fuzzy_dataset.csv           # Fuzzy 随机注入
├── Gear_dataset.csv            # 变速挡位欺骗
└── RPM_dataset.csv             # 转速表欺骗
每个 .csv 文件都记录一段独立实验：约 30–40 min 总时长，期间重复 300 次注入事件，单次攻击持续 3–5 s

| 列名            | 类型    | 描述                   |
| ------------- | ----- | -------------------- |
| `Timestamp`   | float | 记录时间，Unix 秒          |
| `CAN ID`      | hex   | 11-bit ID（示例 `043f`） |
| `DLC`         | int   | Data Length Code，0–8 |
| `DATA[0]…[7]` | hex   | 0–8 字节报文内容           |
| `Flag`        | char  | `T`=注入帧，`R`=正常帧      |

### 代码目录
├─dataset_hack(原始数据集)
│  ├─dataset_img_hack（生成的图片和标签）
│  │  ├─DoS_dataset_img_hack
│  │  │  └─can_images
│  │  │  └─label.csv
│  │  ├─Fuzzy_dataset_img_hack
│  │  │  └─can_images
│  │  │  └─label.csv
│  │  ├─gear_dataset_img_hack
│  │  │  └─can_images
│  │  │  └─label.csv
│  │  └─RPM_dataset_img_hack
│  │      └─can_images
│  │  │  └─label.csv
│  ├─runs
├─runs
│  └─RGBA
│      └─cannet_0.2_20
│          ├─Accuracy_Train
│          ├─Accuracy_Val
│          ├─Loss_Train
│          └─Loss_Val
├─runs_20epoch_rgb_all_data
│  └─can_net_training
│      ├─Accuracy_Train
│      ├─Accuracy_Val
│      ├─Loss_Train
│      └─Loss_Val
├─seq
│  ├─modified_data
│  ├─runs
│  │  ├─can_net_training
│  │  │  ├─Accuracy_Train
│  │  │  ├─Accuracy_Val
│  │  │  ├─Loss_Train
│  │  │  └─Loss_Val
│  │  └─can_net_training_new
│  ├─unable
│  └─__pycache__
├─seq-can-train-test
├─unable
└─__pycache__
## 2、数据预处理
````
> **数据标准**  
> | 字段 | 位宽 | 说明 |  
> |------|------|------|  
> | `timestamp` | 64 bit | us 级采样时间戳 |  
> | `id`        | 11/29 bit | CAN 标识符 |  
> | `dlc`       | 4 bit | 数据长度码 |  
> | `data`      | ≤ 64 bit | 以字节序列存储 |

---

## 2. CAN-RGB 编码  
核心思路：把 *时间*、*ID*、*DLC* 三个维度塞进一张 64 × 64 × 3 的图。

| 通道 | 填充值 | 归一化策略 |
|------|--------|-----------|
| **R** | `timestamp Δt` (μs) | log-minmax (剪长尾) |
| **G** | 标识符 ID | /2048 (11-bit) |
| **B** | DLC | /8 |

伪码：
```python
def encode_window(df):
    r = log_norm(np.diff(df['timestamp'], prepend=df['timestamp'].iloc[0]))
    g = df['id'].astype(np.float32) / 2048
    b = df['dlc'].astype(np.float32) / 8
    img = np.stack([r, g, b], axis=-1)      # shape (N, 3)
    return img.reshape(64, 64, 3)           # N=4096
````

---

## 3. 基线网络 CANET-33K

```
Conv(3,8,k3) → BN+ReLU
Conv(8,32,k3,stride2) → BN+ReLU
MaxPool(2)
FC(32*3*3 → 16) → ReLU
FC(16 → 2)
```

- 总参数：32 960 ≈ 33 k
    
- FLOPs：2.31 M
    
- PyTorch 定义见 `models/canet.py`
    

---

## 4. 一次性混合压缩

### 4.1 结构化剪枝

- 目标稀疏率：50 % 通道级
    
- 方法：`torch.nn.utils.prune.ln_structured`
    
- 剪枝后参数 ↓ 到 **14 416**
    

### 4.2 INT8 Post-Training Quantisation

```python
backend = 'fbgemm'
model.eval()
qconfig = torch.ao.quantization.get_default_qconfig(backend)
qmodel  = torch.ao.quantization.quantize_dynamic(
            model, {nn.Linear}, dtype=torch.qint8)
```

- 参数尺寸：**7 208**
    
- 存储：**17.05 kB**
    
- 精度保持：99.72 %
    

---

## 5. 训练-剪枝-量化流水线

```bash
python scripts/00_rgb_encode.py   # 原始 CAN → .npy
python scripts/10_train_fp32.py   # 20 epochs baseline
python scripts/20_prune.py        # 50 % structured
python scripts/30_ptq_int8.py     # dynamic quant
python scripts/40_eval.py         # 报告 ACC / F1 / ROC
```

输出示例：

```
FP32  : acc 99.89 | params 32.9k
Prune : acc 99.78 | params 14.4k
INT8  : acc 99.72 | params 7.2k  (17.05 kB)
```

---

## 6. 结果复现与可视化

- 混淆矩阵、ROC、PR 曲线均自动保存到 `results/figs/`
    
- `tensorboard --logdir runs` 查看 loss / lr / sparsity 变化
    
- 10-fold cross-vehicle split 配置见 `config/split_*.json`
    

---

## 7. 推理性能基准

|环境|延迟 / 样本|备注|
|---|---|---|
|Ryzen 5800H (FP32)|0.68 ms|torch + ONNX|
|同 CPU (INT8)|0.42 ms|onnxruntime|
|NVIDIA RTX 3060|0.11 ms|fp16 TensorCore|

> **结论**：INT8 在 CPU 侧仅 1.6× 提升；真正收益将在硬件侧体现。

---

## 8. 未来工作

1. **QAT**：量化感知训练，预期 +0.1 pp 精度，INT8 推理更鲁棒。
    
2. **更深剪枝**：探索 70–80 % 稀疏率与 Lottery Ticket style 微调。
    
3. **Domain shift**：跨车型、跨路况增量学习。
    
4. **公开硬件接口**：发布 AXI-stream 数据包 + Verilog 参考，以便快速硬件-in-loop。
    

---

## 9. 参考实现

- `repo_url`：[https://github.com/yourname/CANET-RGB](https://github.com/yourname/CANET-RGB)  
    分支 `lite-fpga` 持续更新
    
- Issues / PR welcome.
    

```

> 复制整份 Markdown 即可放进项目根 README 或内部 Wiki。
```


## HCRL Car-Hacking Dataset — 结构总览

### 1 数据包层级

```
Car-Hacking-Dataset/
├── normal.csv                  # 正常行驶（约 30 min）
├── DoS_dataset.csv             # DoS 注入
├── Fuzzy_dataset.csv           # Fuzzy 随机注入
├── Gear_dataset.csv            # 变速挡位欺骗
└── RPM_dataset.csv             # 转速表欺骗
```

*每个 *.csv 文件都记录一段独立实验：约 30–40 min 总时长，期间**重复 300 次注入事件**，单次攻击持续 3–5 s。([ocslab.hksecurity.net](https://ocslab.hksecurity.net/Datasets/car-hacking-dataset "HCRL - Car-Hacking Dataset"), [techscience.com](https://www.techscience.com/cmc/v76n3/54350/html?utm_source=chatgpt.com "A Comprehensive Analysis of Datasets for Automotive Intrusion ..."))

---

### 2 行格式（共 13 列）

|列名|类型|描述|
|---|---|---|
|`Timestamp`|float|记录时间，Unix 秒|
|`CAN ID`|hex|11-bit ID（示例 `043f`）|
|`DLC`|int|Data Length Code，0–8|
|`DATA[0]…[7]`|hex|0–8 字节报文内容|
|`Flag`|char|`T`=注入帧，`R`=正常帧|

字段定义见数据集页面 1.1 节。([ocslab.hksecurity.net](https://ocslab.hksecurity.net/Datasets/car-hacking-dataset "HCRL - Car-Hacking Dataset"))

---

### 3 五个子数据集的攻击特征

|文件|主攻击策略|注入周期|典型注入 ID / 数据|
|---|---|---|---|
|**DoS**|喷 flood 报文|0.3 ms|`0000`, `00 00 …`|
|**Fuzzy**|随机 ID+DATA|0.5 ms|任意 0x000–0x7FF|
|**Gear**|变速挡位伪造|1 ms|车厂挡位 ID|
|**RPM**|转速表伪造|1 ms|车厂 RPM ID|
|**Normal**|无注入|—|—|

([ocslab.hksecurity.net](https://ocslab.hksecurity.net/Datasets/car-hacking-dataset "HCRL - Car-Hacking Dataset"))

---

### 4 规模与文件大小（Kaggle 镜像）

|文件|大小|帧数（约）|
|---|---|---|
|`DoS_dataset.csv`|190 MB|2.8 M|
|`Fuzzy_dataset.csv`|207 MB|3.1 M|
|`Gear_dataset.csv`|43 MB|0.6 M|
|`RPM_dataset.csv`|54 MB|0.8 M|
|`normal.csv`|343 MB|5.1 M|

([kaggle.com](https://www.kaggle.com/datasets/pranavjha24/car-hacking-dataset/data?utm_source=chatgpt.com "Car-Hacking Dataset - Kaggle"))

---

### 5 时间结构 & 标注细节

- 每个注入段由若干 `T` 标记帧组成，前后夹杂大量 `R` 帧（背景流量）。
    
- 注入段之间约 4–8 s 的正常驾驶流量；文件结尾会出现几十秒长的 **总线静默间隙**（收集工艺遗留），需在预处理时裁剪或插值。([researchgate.net](https://www.researchgate.net/figure/HCRL-Car-Hacking-dataset-contains-unintentional-artifacts-of-data-collection-in_fig4_377596883?utm_source=chatgpt.com "HCRL Car Hacking dataset contains unintentional artifacts of data..."))
    

---

### 6 采集环境

- 车辆：Hyundai YF Sonata（OBD-II 口记录）。
    
- 总线类型：11-bit 标准帧，500 kbps。
    
- 日志工具：Vector CANalyzer + 自研注入脚本。  
    ([orbit.dtu.dk](https://orbit.dtu.dk/files/362948187/3655693.3655696.pdf?utm_source=chatgpt.com "[PDF] Investigating and Evaluating Automotive Intrusion Detection Datasets"))
    

---

### 7 常见数据清洗要点

|问题|建议处理|
|---|---|
|**DLC 固定 8**：无信息量|可删除或视作常数特征|
|**Flag** 极度稀疏|直接用作监督标签；若做无监督 IDS，可先移除|
|**长时间空隙**|填充虚拟心跳帧或截断|
|**严重类别失衡**（正常 ≫ 注入）|下采样正常帧或滑窗重采样|

---

### 8 局限与注意事项

1. **静态周期注入**：攻击模式固定、易于检测，难以模拟隐蔽攻击。
    
2. **单车型**：仅 YF Sonata；ID 分布缺乏跨车型多样性。
    
3. **无物理信号**：仅原始帧，无法做语义级异常分析。
    
4. **收集伪影**：攻击停止后出现数十秒“无报文段”，可能误导时序基特征。
    

> 若需更真实场景，可结合 HCRL Survival-IDS、ROAD 或 ODOS 等数据集做交叉验证。